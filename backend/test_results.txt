npm test

> posting-system-backend@1.0.0 test
> jest

  console.log
    Setup: Initializing test database...

      at Object.<anonymous> (src/__tests__/setup.js:20:11)

  console.log
    Setup: Initializing test database with PostgreSQL...

      at initTestDb (src/__tests__/testDb.js:38:13)

  console.log
    Setup: Initializing test database...

      at Object.<anonymous> (src/__tests__/setup.js:20:11)

  console.log
    Setup: Initializing test database with PostgreSQL...

      at initTestDb (src/__tests__/testDb.js:38:13)

  console.log
    Setup: Initializing test database...

      at Object.<anonymous> (src/__tests__/setup.js:20:11)

  console.log
    Setup: Initializing test database with PostgreSQL...

      at initTestDb (src/__tests__/testDb.js:38:13)

  console.log
    Setup: Initializing test database...

      at Object.<anonymous> (src/__tests__/setup.js:20:11)

  console.log
    Setup: Initializing test database with PostgreSQL...

      at initTestDb (src/__tests__/testDb.js:38:13)

  console.log
    Setup: Initializing test database...

      at Object.<anonymous> (src/__tests__/setup.js:20:11)

  console.log
    Setup: Initializing test database with PostgreSQL...

      at initTestDb (src/__tests__/testDb.js:38:13)

  console.log
    Setup: Initializing test database...

      at Object.<anonymous> (src/__tests__/setup.js:20:11)

  console.log
    Setup: Initializing test database with PostgreSQL...

      at initTestDb (src/__tests__/testDb.js:38:13)

  console.log
    Setup: Initializing test database...

      at Object.<anonymous> (src/__tests__/setup.js:20:11)

  console.log
    Setup: Initializing test database with PostgreSQL...

      at initTestDb (src/__tests__/testDb.js:38:13)

  console.log
    Setup: Initializing test database...

      at Object.<anonymous> (src/__tests__/setup.js:20:11)

  console.log
    Setup: Initializing test database with PostgreSQL...

      at initTestDb (src/__tests__/testDb.js:38:13)

  console.log
    Setup: Initializing test database...

      at Object.<anonymous> (src/__tests__/setup.js:20:11)

  console.log
    Setup: Initializing test database with PostgreSQL...

      at initTestDb (src/__tests__/testDb.js:38:13)

  console.log
    Setup: Initializing test database...

      at Object.<anonymous> (src/__tests__/setup.js:20:11)

  console.log
    Setup: Initializing test database with PostgreSQL...

      at initTestDb (src/__tests__/testDb.js:38:13)

  console.log
    Setup: Initializing test database...

      at Object.<anonymous> (src/__tests__/setup.js:20:11)

  console.log
    Setup: Initializing test database with PostgreSQL...

      at initTestDb (src/__tests__/testDb.js:38:13)

  console.log
    Setup: Initializing test database...

      at Object.<anonymous> (src/__tests__/setup.js:20:11)

  console.log
    Setup: Initializing test database...

      at Object.<anonymous> (src/__tests__/setup.js:20:11)

  console.log
    Setup: Initializing test database with PostgreSQL...

      at initTestDb (src/__tests__/testDb.js:38:13)

  console.log
    Setup: Initializing test database with PostgreSQL...

      at initTestDb (src/__tests__/testDb.js:38:13)

  console.log
    Setup: Initializing test database...

      at Object.<anonymous> (src/__tests__/setup.js:20:11)

  console.log
    Setup: Initializing test database with PostgreSQL...

      at initTestDb (src/__tests__/testDb.js:38:13)

  console.log
    Setup: Initializing test database...

      at Object.<anonymous> (src/__tests__/setup.js:20:11)

  console.log
    Setup: Initializing test database with PostgreSQL...

      at initTestDb (src/__tests__/testDb.js:38:13)

  console.log
    ✅ Test database initialized with PostgreSQL: test_posting_system_1762918251776_lbv0v

      at initTestDb (src/__tests__/testDb.js:97:15)

  console.log
    Setup: Test database initialized

      at Object.<anonymous> (src/__tests__/setup.js:22:11)

  console.log
    ✅ Test database initialized with PostgreSQL: test_posting_system_1762918251802_80wh8

      at initTestDb (src/__tests__/testDb.js:97:15)

  console.log
    Setup: Test database initialized

      at Object.<anonymous> (src/__tests__/setup.js:22:11)

  console.log
    ✅ Test database initialized with PostgreSQL: test_posting_system_1762918251848_yakve

      at initTestDb (src/__tests__/testDb.js:97:15)

  console.log
    ✅ Test database initialized with PostgreSQL: test_posting_system_1762918251893_u9cp3

      at initTestDb (src/__tests__/testDb.js:97:15)

  console.log
    Setup: Test database initialized

      at Object.<anonymous> (src/__tests__/setup.js:22:11)

  console.log
    Setup: Test database initialized

      at Object.<anonymous> (src/__tests__/setup.js:22:11)

  console.log
    ✅ Test database initialized with PostgreSQL: test_posting_system_1762918251873_8dlon

      at initTestDb (src/__tests__/testDb.js:97:15)

  console.log
    Setup: Test database initialized

      at Object.<anonymous> (src/__tests__/setup.js:22:11)

  console.log
    ✅ Test database initialized with PostgreSQL: test_posting_system_1762918251838_y9098

      at initTestDb (src/__tests__/testDb.js:97:15)

  console.log
    ✅ Test database initialized with PostgreSQL: test_posting_system_1762918251888_sd2nj

      at initTestDb (src/__tests__/testDb.js:97:15)

  console.log
    Setup: Test database initialized

      at Object.<anonymous> (src/__tests__/setup.js:22:11)

  console.log
    Setup: Test database initialized

      at Object.<anonymous> (src/__tests__/setup.js:22:11)

  console.log
    ✅ Test database initialized with PostgreSQL: test_posting_system_1762918251875_no57q

      at initTestDb (src/__tests__/testDb.js:97:15)

  console.log
    Setup: Test database initialized

      at Object.<anonymous> (src/__tests__/setup.js:22:11)

  console.log
    ✅ Test database initialized with PostgreSQL: test_posting_system_1762918251855_1mb5v

      at initTestDb (src/__tests__/testDb.js:97:15)

  console.log
    Setup: Test database initialized

      at Object.<anonymous> (src/__tests__/setup.js:22:11)

  console.log
    ✅ Test database initialized with PostgreSQL: test_posting_system_1762918251977_6ta5f

      at initTestDb (src/__tests__/testDb.js:97:15)

  console.log
    Setup: Test database initialized

      at Object.<anonymous> (src/__tests__/setup.js:22:11)

  console.log
    ✅ Test database initialized with PostgreSQL: test_posting_system_1762918251924_xbug0

      at initTestDb (src/__tests__/testDb.js:97:15)

  console.log
    Setup: Test database initialized

      at Object.<anonymous> (src/__tests__/setup.js:22:11)

  console.log
    ✅ Test database initialized with PostgreSQL: test_posting_system_1762918251946_io6qt

      at initTestDb (src/__tests__/testDb.js:97:15)

  console.log
    ✅ Test database initialized with PostgreSQL: test_posting_system_1762918251937_dqi0f

      at initTestDb (src/__tests__/testDb.js:97:15)

  console.log
    ✅ Test database initialized with PostgreSQL: test_posting_system_1762918251919_65fn1

      at initTestDb (src/__tests__/testDb.js:97:15)

  console.log
    Setup: Test database initialized

      at Object.<anonymous> (src/__tests__/setup.js:22:11)

  console.log
    Setup: Test database initialized

      at Object.<anonymous> (src/__tests__/setup.js:22:11)

  console.log
    Setup: Test database initialized

      at Object.<anonymous> (src/__tests__/setup.js:22:11)

  console.log
    ✅ Test database initialized with PostgreSQL: test_posting_system_1762918251937_mbdyd

      at initTestDb (src/__tests__/testDb.js:97:15)

  console.log
    Setup: Test database initialized

      at Object.<anonymous> (src/__tests__/setup.js:22:11)

  console.error
    Failed to clean up file: /home/jason/Development/claude/posting-system-refactor/backend/src/uploads/images/174b93d6-e281-470a-a74c-a7ce849d71f4.jpg Error: ENOENT: no such file or directory, unlink '/home/jason/Development/claude/posting-system-refactor/backend/src/uploads/images/174b93d6-e281-470a-a74c-a7ce849d71f4.jpg'
        at Object.unlink (node:internal/fs/promises:1064:10)
        at /home/jason/Development/claude/posting-system-refactor/backend/src/routes/media.js:237:13 {
      errno: -2,
      code: 'ENOENT',
      syscall: 'unlink',
      path: '/home/jason/Development/claude/posting-system-refactor/backend/src/uploads/images/174b93d6-e281-470a-a74c-a7ce849d71f4.jpg'
    }

      237 |             await fs.unlink(file.path);
      238 |           } catch (unlinkError) {
    > 239 |             console.error('Failed to clean up file:', file.path, unlinkError);
          |                     ^
      240 |           }
      241 |         }
      242 |       }

      at src/routes/media.js:239:21

  console.warn
    Optional authentication failed: invalid token

      149 |     } catch (tokenError) {
      150 |       // Token is invalid, but we continue without authentication
    > 151 |       console.warn('Optional authentication failed:', tokenError.message);
          |               ^
      152 |     }
      153 |
      154 |     next();

      at optionalAuthenticate (src/middleware/auth.js:151:15)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at cookieParser (node_modules/cookie-parser/index.js:46:14)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at cookieParser (node_modules/cookie-parser/index.js:57:14)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at jsonParser (node_modules/body-parser/lib/types/json.js:113:7)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at expressInit (node_modules/express/lib/middleware/init.js:40:5)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at query (node_modules/express/lib/middleware/query.js:45:5)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Function.handle (node_modules/express/lib/router/index.js:175:3)
      at Function.handle (node_modules/express/lib/application.js:181:10)
      at Server.app (node_modules/express/lib/express.js:39:9)

  console.error
    Comment creation error: Error: Maximum comment nesting depth exceeded
        at Comment.create (/home/jason/Development/claude/posting-system-refactor/backend/src/models/Comment.js:38:15)
        at processTicksAndRejections (node:internal/process/task_queues:105:5)
        at /home/jason/Development/claude/posting-system-refactor/backend/src/routes/comments.js:679:23

      744 |
      745 |     } catch (error) {
    > 746 |       console.error('Comment creation error:', error);
          |               ^
      747 |
      748 |       // Handle specific validation errors
      749 |       if (error.message.includes('Maximum comment nesting depth exceeded')) {

      at src/routes/comments.js:746:15

  console.warn
    Geocoding failed for user address update: Address not found

      383 |             }
      384 |           } else {
    > 385 |             console.warn('Geocoding failed for user address update:', geocodeResult.error);
          |                     ^
      386 |             // Continue with update even if geocoding fails
      387 |           }
      388 |         } catch (geocodeError) {

      at src/routes/users.js:385:21

  console.error
    Error: {
      message: 'Test error',
      stack: 'Error: Test error\n' +
        '    at /home/jason/Development/claude/posting-system-refactor/backend/src/__tests__/middleware.test.js:458:21\n' +
        '    at Layer.handle [as handle_request] (/home/jason/Development/claude/posting-system-refactor/backend/node_modules/express/lib/router/layer.js:95:5)\n' +
        '    at next (/home/jason/Development/claude/posting-system-refactor/backend/node_modules/express/lib/router/route.js:149:13)\n' +
        '    at Route.dispatch (/home/jason/Development/claude/posting-system-refactor/backend/node_modules/express/lib/router/route.js:119:3)\n' +
        '    at Layer.handle [as handle_request] (/home/jason/Development/claude/posting-system-refactor/backend/node_modules/express/lib/router/layer.js:95:5)\n' +
        '    at /home/jason/Development/claude/posting-system-refactor/backend/node_modules/express/lib/router/index.js:284:15\n' +
        '    at Function.process_params (/home/jason/Development/claude/posting-system-refactor/backend/node_modules/express/lib/router/index.js:346:12)\n' +
        '    at next (/home/jason/Development/claude/posting-system-refactor/backend/node_modules/express/lib/router/index.js:280:10)\n' +
        '    at cookieParser (/home/jason/Development/claude/posting-system-refactor/backend/node_modules/cookie-parser/index.js:57:14)\n' +
        '    at Layer.handle [as handle_request] (/home/jason/Development/claude/posting-system-refactor/backend/node_modules/express/lib/router/layer.js:95:5)\n' +
        '    at trim_prefix (/home/jason/Development/claude/posting-system-refactor/backend/node_modules/express/lib/router/index.js:328:13)\n' +
        '    at /home/jason/Development/claude/posting-system-refactor/backend/node_modules/express/lib/router/index.js:286:9\n' +
        '    at Function.process_params (/home/jason/Development/claude/posting-system-refactor/backend/node_modules/express/lib/router/index.js:346:12)\n' +
        '    at next (/home/jason/Development/claude/posting-system-refactor/backend/node_modules/express/lib/router/index.js:280:10)\n' +
        '    at jsonParser (/home/jason/Development/claude/posting-system-refactor/backend/node_modules/body-parser/lib/types/json.js:113:7)\n' +
        '    at Layer.handle [as handle_request] (/home/jason/Development/claude/posting-system-refactor/backend/node_modules/express/lib/router/layer.js:95:5)\n' +
        '    at trim_prefix (/home/jason/Development/claude/posting-system-refactor/backend/node_modules/express/lib/router/index.js:328:13)\n' +
        '    at /home/jason/Development/claude/posting-system-refactor/backend/node_modules/express/lib/router/index.js:286:9\n' +
        '    at Function.process_params (/home/jason/Development/claude/posting-system-refactor/backend/node_modules/express/lib/router/index.js:346:12)\n' +
        '    at next (/home/jason/Development/claude/posting-system-refactor/backend/node_modules/express/lib/router/index.js:280:10)\n' +
        '    at expressInit (/home/jason/Development/claude/posting-system-refactor/backend/node_modules/express/lib/middleware/init.js:40:5)\n' +
        '    at Layer.handle [as handle_request] (/home/jason/Development/claude/posting-system-refactor/backend/node_modules/express/lib/router/layer.js:95:5)\n' +
        '    at trim_prefix (/home/jason/Development/claude/posting-system-refactor/backend/node_modules/express/lib/router/index.js:328:13)\n' +
        '    at /home/jason/Development/claude/posting-system-refactor/backend/node_modules/express/lib/router/index.js:286:9\n' +
        '    at Function.process_params (/home/jason/Development/claude/posting-system-refactor/backend/node_modules/express/lib/router/index.js:346:12)\n' +
        '    at next (/home/jason/Development/claude/posting-system-refactor/backend/node_modules/express/lib/router/index.js:280:10)\n' +
        '    at query (/home/jason/Development/claude/posting-system-refactor/backend/node_modules/express/lib/middleware/query.js:45:5)\n' +
        '    at Layer.handle [as handle_request] (/home/jason/Development/claude/posting-system-refactor/backend/node_modules/express/lib/router/layer.js:95:5)\n' +
        '    at trim_prefix (/home/jason/Development/claude/posting-system-refactor/backend/node_modules/express/lib/router/index.js:328:13)\n' +
        '    at /home/jason/Development/claude/posting-system-refactor/backend/node_modules/express/lib/router/index.js:286:9\n' +
        '    at Function.process_params (/home/jason/Development/claude/posting-system-refactor/backend/node_modules/express/lib/router/index.js:346:12)\n' +
        '    at next (/home/jason/Development/claude/posting-system-refactor/backend/node_modules/express/lib/router/index.js:280:10)\n' +
        '    at Function.handle (/home/jason/Development/claude/posting-system-refactor/backend/node_modules/express/lib/router/index.js:175:3)\n' +
        '    at Function.handle (/home/jason/Development/claude/posting-system-refactor/backend/node_modules/express/lib/application.js:181:10)\n' +
        '    at Server.app (/home/jason/Development/claude/posting-system-refactor/backend/node_modules/express/lib/express.js:39:9)\n' +
        '    at Server.emit (node:events:518:28)\n' +
        '    at parserOnIncoming (node:_http_server:1153:12)\n' +
        '    at HTTPParser.parserOnHeadersComplete (node:_http_common:117:17)',
      url: '/error',
      method: 'GET',
      body: {},
      params: {},
      query: {},
      ip: '::ffff:127.0.0.1',
      userAgent: undefined
    }

      16 |
      17 |   // Log error for debugging
    > 18 |   console.error('Error:', {
         |           ^
      19 |     message: err.message,
      20 |     stack: err.stack,
      21 |     url: req.url,

      at errorHandler (src/middleware/errorHandler.js:18:11)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:71:5)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at next (node_modules/express/lib/router/route.js:141:14)
      at src/__tests__/middleware.test.js:461:7
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at next (node_modules/express/lib/router/route.js:149:13)
      at Route.dispatch (node_modules/express/lib/router/route.js:119:3)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at node_modules/express/lib/router/index.js:284:15
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at cookieParser (node_modules/cookie-parser/index.js:57:14)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at jsonParser (node_modules/body-parser/lib/types/json.js:113:7)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at expressInit (node_modules/express/lib/middleware/init.js:40:5)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at query (node_modules/express/lib/middleware/query.js:45:5)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Function.handle (node_modules/express/lib/router/index.js:175:3)
      at Function.handle (node_modules/express/lib/application.js:181:10)
      at Server.app (node_modules/express/lib/express.js:39:9)

  console.error
    Error: {
      message: 'Validation failed',
      stack: 'Error: Validation failed\n' +
        '    at /home/jason/Development/claude/posting-system-refactor/backend/src/__tests__/middleware.test.js:466:21\n' +
        '    at Layer.handle [as handle_request] (/home/jason/Development/claude/posting-system-refactor/backend/node_modules/express/lib/router/layer.js:95:5)\n' +
        '    at next (/home/jason/Development/claude/posting-system-refactor/backend/node_modules/express/lib/router/route.js:149:13)\n' +
        '    at Route.dispatch (/home/jason/Development/claude/posting-system-refactor/backend/node_modules/express/lib/router/route.js:119:3)\n' +
        '    at Layer.handle [as handle_request] (/home/jason/Development/claude/posting-system-refactor/backend/node_modules/express/lib/router/layer.js:95:5)\n' +
        '    at /home/jason/Development/claude/posting-system-refactor/backend/node_modules/express/lib/router/index.js:284:15\n' +
        '    at Function.process_params (/home/jason/Development/claude/posting-system-refactor/backend/node_modules/express/lib/router/index.js:346:12)\n' +
        '    at next (/home/jason/Development/claude/posting-system-refactor/backend/node_modules/express/lib/router/index.js:280:10)\n' +
        '    at cookieParser (/home/jason/Development/claude/posting-system-refactor/backend/node_modules/cookie-parser/index.js:57:14)\n' +
        '    at Layer.handle [as handle_request] (/home/jason/Development/claude/posting-system-refactor/backend/node_modules/express/lib/router/layer.js:95:5)\n' +
        '    at trim_prefix (/home/jason/Development/claude/posting-system-refactor/backend/node_modules/express/lib/router/index.js:328:13)\n' +
        '    at /home/jason/Development/claude/posting-system-refactor/backend/node_modules/express/lib/router/index.js:286:9\n' +
        '    at Function.process_params (/home/jason/Development/claude/posting-system-refactor/backend/node_modules/express/lib/router/index.js:346:12)\n' +
        '    at next (/home/jason/Development/claude/posting-system-refactor/backend/node_modules/express/lib/router/index.js:280:10)\n' +
        '    at jsonParser (/home/jason/Development/claude/posting-system-refactor/backend/node_modules/body-parser/lib/types/json.js:113:7)\n' +
        '    at Layer.handle [as handle_request] (/home/jason/Development/claude/posting-system-refactor/backend/node_modules/express/lib/router/layer.js:95:5)\n' +
        '    at trim_prefix (/home/jason/Development/claude/posting-system-refactor/backend/node_modules/express/lib/router/index.js:328:13)\n' +
        '    at /home/jason/Development/claude/posting-system-refactor/backend/node_modules/express/lib/router/index.js:286:9\n' +
        '    at Function.process_params (/home/jason/Development/claude/posting-system-refactor/backend/node_modules/express/lib/router/index.js:346:12)\n' +
        '    at next (/home/jason/Development/claude/posting-system-refactor/backend/node_modules/express/lib/router/index.js:280:10)\n' +
        '    at expressInit (/home/jason/Development/claude/posting-system-refactor/backend/node_modules/express/lib/middleware/init.js:40:5)\n' +
        '    at Layer.handle [as handle_request] (/home/jason/Development/claude/posting-system-refactor/backend/node_modules/express/lib/router/layer.js:95:5)\n' +
        '    at trim_prefix (/home/jason/Development/claude/posting-system-refactor/backend/node_modules/express/lib/router/index.js:328:13)\n' +
        '    at /home/jason/Development/claude/posting-system-refactor/backend/node_modules/express/lib/router/index.js:286:9\n' +
        '    at Function.process_params (/home/jason/Development/claude/posting-system-refactor/backend/node_modules/express/lib/router/index.js:346:12)\n' +
        '    at next (/home/jason/Development/claude/posting-system-refactor/backend/node_modules/express/lib/router/index.js:280:10)\n' +
        '    at query (/home/jason/Development/claude/posting-system-refactor/backend/node_modules/express/lib/middleware/query.js:45:5)\n' +
        '    at Layer.handle [as handle_request] (/home/jason/Development/claude/posting-system-refactor/backend/node_modules/express/lib/router/layer.js:95:5)\n' +
        '    at trim_prefix (/home/jason/Development/claude/posting-system-refactor/backend/node_modules/express/lib/router/index.js:328:13)\n' +
        '    at /home/jason/Development/claude/posting-system-refactor/backend/node_modules/express/lib/router/index.js:286:9\n' +
        '    at Function.process_params (/home/jason/Development/claude/posting-system-refactor/backend/node_modules/express/lib/router/index.js:346:12)\n' +
        '    at next (/home/jason/Development/claude/posting-system-refactor/backend/node_modules/express/lib/router/index.js:280:10)\n' +
        '    at Function.handle (/home/jason/Development/claude/posting-system-refactor/backend/node_modules/express/lib/router/index.js:175:3)\n' +
        '    at Function.handle (/home/jason/Development/claude/posting-system-refactor/backend/node_modules/express/lib/application.js:181:10)\n' +
        '    at Server.app (/home/jason/Development/claude/posting-system-refactor/backend/node_modules/express/lib/express.js:39:9)\n' +
        '    at Server.emit (node:events:518:28)\n' +
        '    at parserOnIncoming (node:_http_server:1153:12)\n' +
        '    at HTTPParser.parserOnHeadersComplete (node:_http_common:117:17)',
      url: '/validation-error',
      method: 'GET',
      body: {},
      params: {},
      query: {},
      ip: '::ffff:127.0.0.1',
      userAgent: undefined
    }

      16 |
      17 |   // Log error for debugging
    > 18 |   console.error('Error:', {
         |           ^
      19 |     message: err.message,
      20 |     stack: err.stack,
      21 |     url: req.url,

      at errorHandler (src/middleware/errorHandler.js:18:11)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:71:5)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at next (node_modules/express/lib/router/route.js:141:14)
      at src/__tests__/middleware.test.js:470:7
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at next (node_modules/express/lib/router/route.js:149:13)
      at Route.dispatch (node_modules/express/lib/router/route.js:119:3)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at node_modules/express/lib/router/index.js:284:15
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at cookieParser (node_modules/cookie-parser/index.js:57:14)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at jsonParser (node_modules/body-parser/lib/types/json.js:113:7)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at expressInit (node_modules/express/lib/middleware/init.js:40:5)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at query (node_modules/express/lib/middleware/query.js:45:5)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Function.handle (node_modules/express/lib/router/index.js:175:3)
      at Function.handle (node_modules/express/lib/application.js:181:10)
      at Server.app (node_modules/express/lib/express.js:39:9)

  console.error
    Error: {
      message: 'Unknown error',
      stack: 'Error: Unknown error\n' +
        '    at /home/jason/Development/claude/posting-system-refactor/backend/src/__tests__/middleware.test.js:475:13\n' +
        '    at Layer.handle [as handle_request] (/home/jason/Development/claude/posting-system-refactor/backend/node_modules/express/lib/router/layer.js:95:5)\n' +
        '    at next (/home/jason/Development/claude/posting-system-refactor/backend/node_modules/express/lib/router/route.js:149:13)\n' +
        '    at Route.dispatch (/home/jason/Development/claude/posting-system-refactor/backend/node_modules/express/lib/router/route.js:119:3)\n' +
        '    at Layer.handle [as handle_request] (/home/jason/Development/claude/posting-system-refactor/backend/node_modules/express/lib/router/layer.js:95:5)\n' +
        '    at /home/jason/Development/claude/posting-system-refactor/backend/node_modules/express/lib/router/index.js:284:15\n' +
        '    at Function.process_params (/home/jason/Development/claude/posting-system-refactor/backend/node_modules/express/lib/router/index.js:346:12)\n' +
        '    at next (/home/jason/Development/claude/posting-system-refactor/backend/node_modules/express/lib/router/index.js:280:10)\n' +
        '    at cookieParser (/home/jason/Development/claude/posting-system-refactor/backend/node_modules/cookie-parser/index.js:57:14)\n' +
        '    at Layer.handle [as handle_request] (/home/jason/Development/claude/posting-system-refactor/backend/node_modules/express/lib/router/layer.js:95:5)\n' +
        '    at trim_prefix (/home/jason/Development/claude/posting-system-refactor/backend/node_modules/express/lib/router/index.js:328:13)\n' +
        '    at /home/jason/Development/claude/posting-system-refactor/backend/node_modules/express/lib/router/index.js:286:9\n' +
        '    at Function.process_params (/home/jason/Development/claude/posting-system-refactor/backend/node_modules/express/lib/router/index.js:346:12)\n' +
        '    at next (/home/jason/Development/claude/posting-system-refactor/backend/node_modules/express/lib/router/index.js:280:10)\n' +
        '    at jsonParser (/home/jason/Development/claude/posting-system-refactor/backend/node_modules/body-parser/lib/types/json.js:113:7)\n' +
        '    at Layer.handle [as handle_request] (/home/jason/Development/claude/posting-system-refactor/backend/node_modules/express/lib/router/layer.js:95:5)\n' +
        '    at trim_prefix (/home/jason/Development/claude/posting-system-refactor/backend/node_modules/express/lib/router/index.js:328:13)\n' +
        '    at /home/jason/Development/claude/posting-system-refactor/backend/node_modules/express/lib/router/index.js:286:9\n' +
        '    at Function.process_params (/home/jason/Development/claude/posting-system-refactor/backend/node_modules/express/lib/router/index.js:346:12)\n' +
        '    at next (/home/jason/Development/claude/posting-system-refactor/backend/node_modules/express/lib/router/index.js:280:10)\n' +
        '    at expressInit (/home/jason/Development/claude/posting-system-refactor/backend/node_modules/express/lib/middleware/init.js:40:5)\n' +
        '    at Layer.handle [as handle_request] (/home/jason/Development/claude/posting-system-refactor/backend/node_modules/express/lib/router/layer.js:95:5)\n' +
        '    at trim_prefix (/home/jason/Development/claude/posting-system-refactor/backend/node_modules/express/lib/router/index.js:328:13)\n' +
        '    at /home/jason/Development/claude/posting-system-refactor/backend/node_modules/express/lib/router/index.js:286:9\n' +
        '    at Function.process_params (/home/jason/Development/claude/posting-system-refactor/backend/node_modules/express/lib/router/index.js:346:12)\n' +
        '    at next (/home/jason/Development/claude/posting-system-refactor/backend/node_modules/express/lib/router/index.js:280:10)\n' +
        '    at query (/home/jason/Development/claude/posting-system-refactor/backend/node_modules/express/lib/middleware/query.js:45:5)\n' +
        '    at Layer.handle [as handle_request] (/home/jason/Development/claude/posting-system-refactor/backend/node_modules/express/lib/router/layer.js:95:5)\n' +
        '    at trim_prefix (/home/jason/Development/claude/posting-system-refactor/backend/node_modules/express/lib/router/index.js:328:13)\n' +
        '    at /home/jason/Development/claude/posting-system-refactor/backend/node_modules/express/lib/router/index.js:286:9\n' +
        '    at Function.process_params (/home/jason/Development/claude/posting-system-refactor/backend/node_modules/express/lib/router/index.js:346:12)\n' +
        '    at next (/home/jason/Development/claude/posting-system-refactor/backend/node_modules/express/lib/router/index.js:280:10)\n' +
        '    at Function.handle (/home/jason/Development/claude/posting-system-refactor/backend/node_modules/express/lib/router/index.js:175:3)\n' +
        '    at Function.handle (/home/jason/Development/claude/posting-system-refactor/backend/node_modules/express/lib/application.js:181:10)\n' +
        '    at Server.app (/home/jason/Development/claude/posting-system-refactor/backend/node_modules/express/lib/express.js:39:9)\n' +
        '    at Server.emit (node:events:518:28)\n' +
        '    at parserOnIncoming (node:_http_server:1153:12)\n' +
        '    at HTTPParser.parserOnHeadersComplete (node:_http_common:117:17)',
      url: '/unknown-error',
      method: 'GET',
      body: {},
      params: {},
      query: {},
      ip: '::ffff:127.0.0.1',
      userAgent: undefined
    }

      16 |
      17 |   // Log error for debugging
    > 18 |   console.error('Error:', {
         |           ^
      19 |     message: err.message,
      20 |     stack: err.stack,
      21 |     url: req.url,

      at errorHandler (src/middleware/errorHandler.js:18:11)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:71:5)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at next (node_modules/express/lib/router/route.js:141:14)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:97:5)
      at next (node_modules/express/lib/router/route.js:149:13)
      at Route.dispatch (node_modules/express/lib/router/route.js:119:3)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at node_modules/express/lib/router/index.js:284:15
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at cookieParser (node_modules/cookie-parser/index.js:57:14)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at jsonParser (node_modules/body-parser/lib/types/json.js:113:7)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at expressInit (node_modules/express/lib/middleware/init.js:40:5)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at query (node_modules/express/lib/middleware/query.js:45:5)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Function.handle (node_modules/express/lib/router/index.js:175:3)
      at Function.handle (node_modules/express/lib/application.js:181:10)
      at Server.app (node_modules/express/lib/express.js:39:9)

  console.log
    404 - Route not found: GET /non-existent-route

      at notFound (src/middleware/notFound.js:14:11)

  console.error
    Error: {
      message: 'Route not found - GET /non-existent-route',
      stack: 'Error: Route not found - GET /non-existent-route\n' +
        '    at notFound (/home/jason/Development/claude/posting-system-refactor/backend/src/middleware/notFound.js:17:17)\n' +
        '    at Layer.handle [as handle_request] (/home/jason/Development/claude/posting-system-refactor/backend/node_modules/express/lib/router/layer.js:95:5)\n' +
        '    at trim_prefix (/home/jason/Development/claude/posting-system-refactor/backend/node_modules/express/lib/router/index.js:328:13)\n' +
        '    at /home/jason/Development/claude/posting-system-refactor/backend/node_modules/express/lib/router/index.js:286:9\n' +
        '    at Function.process_params (/home/jason/Development/claude/posting-system-refactor/backend/node_modules/express/lib/router/index.js:346:12)\n' +
        '    at next (/home/jason/Development/claude/posting-system-refactor/backend/node_modules/express/lib/router/index.js:280:10)\n' +
        '    at expressInit (/home/jason/Development/claude/posting-system-refactor/backend/node_modules/express/lib/middleware/init.js:40:5)\n' +
        '    at Layer.handle [as handle_request] (/home/jason/Development/claude/posting-system-refactor/backend/node_modules/express/lib/router/layer.js:95:5)\n' +
        '    at trim_prefix (/home/jason/Development/claude/posting-system-refactor/backend/node_modules/express/lib/router/index.js:328:13)\n' +
        '    at /home/jason/Development/claude/posting-system-refactor/backend/node_modules/express/lib/router/index.js:286:9\n' +
        '    at Function.process_params (/home/jason/Development/claude/posting-system-refactor/backend/node_modules/express/lib/router/index.js:346:12)\n' +
        '    at next (/home/jason/Development/claude/posting-system-refactor/backend/node_modules/express/lib/router/index.js:280:10)\n' +
        '    at query (/home/jason/Development/claude/posting-system-refactor/backend/node_modules/express/lib/middleware/query.js:45:5)\n' +
        '    at Layer.handle [as handle_request] (/home/jason/Development/claude/posting-system-refactor/backend/node_modules/express/lib/router/layer.js:95:5)\n' +
        '    at trim_prefix (/home/jason/Development/claude/posting-system-refactor/backend/node_modules/express/lib/router/index.js:328:13)\n' +
        '    at /home/jason/Development/claude/posting-system-refactor/backend/node_modules/express/lib/router/index.js:286:9\n' +
        '    at Function.process_params (/home/jason/Development/claude/posting-system-refactor/backend/node_modules/express/lib/router/index.js:346:12)\n' +
        '    at next (/home/jason/Development/claude/posting-system-refactor/backend/node_modules/express/lib/router/index.js:280:10)\n' +
        '    at Function.handle (/home/jason/Development/claude/posting-system-refactor/backend/node_modules/express/lib/router/index.js:175:3)\n' +
        '    at Function.handle (/home/jason/Development/claude/posting-system-refactor/backend/node_modules/express/lib/application.js:181:10)\n' +
        '    at Server.app (/home/jason/Development/claude/posting-system-refactor/backend/node_modules/express/lib/express.js:39:9)\n' +
        '    at Server.emit (node:events:518:28)\n' +
        '    at parserOnIncoming (node:_http_server:1153:12)\n' +
        '    at HTTPParser.parserOnHeadersComplete (node:_http_common:117:17)',
      url: '/non-existent-route',
      method: 'GET',
      body: undefined,
      params: {},
      query: {},
      ip: '::ffff:127.0.0.1',
      userAgent: undefined
    }

      16 |
      17 |   // Log error for debugging
    > 18 |   console.error('Error:', {
         |           ^
      19 |     message: err.message,
      20 |     stack: err.stack,
      21 |     url: req.url,

      at errorHandler (src/middleware/errorHandler.js:18:11)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:71:5)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at notFound (src/middleware/notFound.js:22:3)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at expressInit (node_modules/express/lib/middleware/init.js:40:5)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at query (node_modules/express/lib/middleware/query.js:45:5)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Function.handle (node_modules/express/lib/router/index.js:175:3)
      at Function.handle (node_modules/express/lib/application.js:181:10)
      at Server.app (node_modules/express/lib/express.js:39:9)

  console.log
    404 - Route not found: POST /api/non-existent

      at notFound (src/middleware/notFound.js:14:11)

  console.error
    Error: {
      message: 'Route not found - POST /api/non-existent',
      stack: 'Error: Route not found - POST /api/non-existent\n' +
        '    at notFound (/home/jason/Development/claude/posting-system-refactor/backend/src/middleware/notFound.js:17:17)\n' +
        '    at Layer.handle [as handle_request] (/home/jason/Development/claude/posting-system-refactor/backend/node_modules/express/lib/router/layer.js:95:5)\n' +
        '    at trim_prefix (/home/jason/Development/claude/posting-system-refactor/backend/node_modules/express/lib/router/index.js:328:13)\n' +
        '    at /home/jason/Development/claude/posting-system-refactor/backend/node_modules/express/lib/router/index.js:286:9\n' +
        '    at Function.process_params (/home/jason/Development/claude/posting-system-refactor/backend/node_modules/express/lib/router/index.js:346:12)\n' +
        '    at next (/home/jason/Development/claude/posting-system-refactor/backend/node_modules/express/lib/router/index.js:280:10)\n' +
        '    at expressInit (/home/jason/Development/claude/posting-system-refactor/backend/node_modules/express/lib/middleware/init.js:40:5)\n' +
        '    at Layer.handle [as handle_request] (/home/jason/Development/claude/posting-system-refactor/backend/node_modules/express/lib/router/layer.js:95:5)\n' +
        '    at trim_prefix (/home/jason/Development/claude/posting-system-refactor/backend/node_modules/express/lib/router/index.js:328:13)\n' +
        '    at /home/jason/Development/claude/posting-system-refactor/backend/node_modules/express/lib/router/index.js:286:9\n' +
        '    at Function.process_params (/home/jason/Development/claude/posting-system-refactor/backend/node_modules/express/lib/router/index.js:346:12)\n' +
        '    at next (/home/jason/Development/claude/posting-system-refactor/backend/node_modules/express/lib/router/index.js:280:10)\n' +
        '    at query (/home/jason/Development/claude/posting-system-refactor/backend/node_modules/express/lib/middleware/query.js:45:5)\n' +
        '    at Layer.handle [as handle_request] (/home/jason/Development/claude/posting-system-refactor/backend/node_modules/express/lib/router/layer.js:95:5)\n' +
        '    at trim_prefix (/home/jason/Development/claude/posting-system-refactor/backend/node_modules/express/lib/router/index.js:328:13)\n' +
        '    at /home/jason/Development/claude/posting-system-refactor/backend/node_modules/express/lib/router/index.js:286:9\n' +
        '    at Function.process_params (/home/jason/Development/claude/posting-system-refactor/backend/node_modules/express/lib/router/index.js:346:12)\n' +
        '    at next (/home/jason/Development/claude/posting-system-refactor/backend/node_modules/express/lib/router/index.js:280:10)\n' +
        '    at Function.handle (/home/jason/Development/claude/posting-system-refactor/backend/node_modules/express/lib/router/index.js:175:3)\n' +
        '    at Function.handle (/home/jason/Development/claude/posting-system-refactor/backend/node_modules/express/lib/application.js:181:10)\n' +
        '    at Server.app (/home/jason/Development/claude/posting-system-refactor/backend/node_modules/express/lib/express.js:39:9)\n' +
        '    at Server.emit (node:events:518:28)\n' +
        '    at parserOnIncoming (node:_http_server:1153:12)\n' +
        '    at HTTPParser.parserOnHeadersComplete (node:_http_common:117:17)',
      url: '/api/non-existent',
      method: 'POST',
      body: undefined,
      params: {},
      query: {},
      ip: '::ffff:127.0.0.1',
      userAgent: undefined
    }

      16 |
      17 |   // Log error for debugging
    > 18 |   console.error('Error:', {
         |           ^
      19 |     message: err.message,
      20 |     stack: err.stack,
      21 |     url: req.url,

      at errorHandler (src/middleware/errorHandler.js:18:11)
      at Layer.handle_error (node_modules/express/lib/router/layer.js:71:5)
      at trim_prefix (node_modules/express/lib/router/index.js:326:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at notFound (src/middleware/notFound.js:22:3)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at expressInit (node_modules/express/lib/middleware/init.js:40:5)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at query (node_modules/express/lib/middleware/query.js:45:5)
      at Layer.handle [as handle_request] (node_modules/express/lib/router/layer.js:95:5)
      at trim_prefix (node_modules/express/lib/router/index.js:328:13)
      at node_modules/express/lib/router/index.js:286:9
      at Function.process_params (node_modules/express/lib/router/index.js:346:12)
      at next (node_modules/express/lib/router/index.js:280:10)
      at Function.handle (node_modules/express/lib/router/index.js:175:3)
      at Function.handle (node_modules/express/lib/application.js:181:10)
      at Server.app (node_modules/express/lib/express.js:39:9)

  console.warn
    Geocoding failed for user address update: Address not found

      383 |             }
      384 |           } else {
    > 385 |             console.warn('Geocoding failed for user address update:', geocodeResult.error);
          |                     ^
      386 |             // Continue with update even if geocoding fails
      387 |           }
      388 |         } catch (geocodeError) {

      at src/routes/users.js:385:21

 FAIL  src/__tests__/utils.test.js (306.85 s)


  ● Test suite failed to run

    thrown: "Exceeded timeout of 300000 ms for a hook.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      24 |
      25 | // Clean up after all tests
    > 26 | afterAll(async () => {
         | ^
      27 |   await cleanTestDb();
      28 | }, 300000); // 300 second timeout for cleanup (increased for parallel test runs)
      29 |

      at Object.<anonymous> (src/__tests__/setup.js:26:1)

 PASS  src/__tests__/location.test.js (339.242 s)
  Location Routes
    POST /api/location/update - Update location
      ✓ should allow authenticated user to update their location (7304 ms)
      ✓ should reject invalid coordinates (7393 ms)
      ✓ should reject missing latitude (6883 ms)
      ✓ should require authentication (7361 ms)
    GET /api/location/me - Get my location
      ✓ should return user's current location (7257 ms)
      ✓ should require authentication (7111 ms)
    GET /api/location/user/:userId - Get user location
      ✓ should return user location when sharing is exact (7161 ms)
      ✓ should hide coordinates when sharing is city (7577 ms)
      ✓ should hide all location when sharing is off (7213 ms)
    POST /api/location/nearby - Find nearby users
      ✓ should find users within specified radius (7188 ms)
      ✓ should validate radius range (7306 ms)
      ✓ should validate coordinates (7471 ms)
      ✓ should include distance in results (7248 ms)
    PUT /api/location/preferences - Update preferences
      ✓ should update location sharing preference (7426 ms)
      ✓ should validate sharing level (7827 ms)
      ✓ should accept valid sharing levels (7848 ms)
    GET /api/location/history - Get location history
      ✓ should return location history for user (9949 ms)
      ✓ should limit history results (7792 ms)
    POST /api/location/distance - Calculate distance
      ✓ should calculate distance between two points (7835 ms)
      ✓ should validate all coordinates (7986 ms)
    GET /api/location/stats - Get statistics
      ✓ should return location statistics (6969 ms)

 PASS  src/__tests__/timeline.test.js (339.289 s)
  Timeline Routes
    GET /api/timeline - Get personalized timeline
      ✓ should return personalized timeline for authenticated user (7304 ms)
      ✓ should support min_score filtering (7467 ms)
      ✓ should generate timeline if cache is empty (6969 ms)
      ✓ should require authentication (7290 ms)
      ✓ should support pagination (7273 ms)
    GET /api/timeline/following - Get following feed
      ✓ should return posts only from followed users (7132 ms)
      ✓ should return empty array if not following anyone (7190 ms)
      ✓ should require authentication (7500 ms)
      ✓ should support pagination (7296 ms)
    GET /api/timeline/discover - Get discover feed
      ✓ should return popular/suggested posts (7164 ms)
      ✓ should respect limit parameter (7271 ms)
      ✓ should require authentication (7419 ms)
    GET /api/timeline/trending - Get trending posts
      ✓ should return trending posts based on engagement (7140 ms)
      ✓ should support custom timeframe (7510 ms)
      ✓ should work without authentication (public endpoint) (7887 ms)
    POST /api/timeline/refresh - Refresh timeline cache
      ✓ should regenerate timeline cache for user (7813 ms)
      ✓ should require authentication (9988 ms)
    GET /api/timeline/stats - Get timeline cache statistics
      ✓ should return cache statistics (7849 ms)
      ✓ should require authentication (7790 ms)
    DELETE /api/timeline/cleanup - Clean up expired entries
      ✓ should clean up expired timeline entries (8071 ms)
      ✓ should require authentication (7000 ms)
    Timeline Algorithm Integration
      ✓ should score posts based on algorithm (7163 ms)
      ✓ should prioritize posts from followed users (7096 ms)

 PASS  src/__tests__/middleware.test.js (339.321 s)
  Authentication Middleware
    authenticate middleware
      ✓ should authenticate user with valid Bearer token (6903 ms)
      ✓ should authenticate user with cookie token (7061 ms)
      ✓ should reject request without token (6520 ms)
      ✓ should reject request with invalid token (6942 ms)
      ✓ should reject request with expired token (6798 ms)
      ✓ should reject request for inactive user (6703 ms)
      ✓ should reject request for non-existent user (6816 ms)
      ✓ should prefer Authorization header over cookie (6990 ms)
    optionalAuthenticate middleware
      ✓ should set user when valid token provided (6957 ms)
      ✓ should continue without user when no token provided (6775 ms)
      ✓ should continue without user when invalid token provided (6758 ms)
      ✓ should not set user for inactive account (7114 ms)
    requireRoles middleware
      ✓ should allow admin user (ID = 1) (7132 ms)
      ✓ should reject non-admin user (6785 ms)
      ✓ should reject unauthenticated request (7367 ms)
    requireOwnership middleware
      ✓ should allow owner to access resource (7395 ms)
      ✓ should reject non-owner (7384 ms)
      ✓ should check user_id from request body (10135 ms)
      ✓ should reject when no user_id provided (7345 ms)
    requireModifyPermission middleware
      ✓ should allow owner to modify resource (7403 ms)
      ✓ should allow admin to modify any resource (7953 ms)
      ✓ should reject non-owner non-admin (6754 ms)
    generateToken function
      ✓ should generate valid JWT token (6749 ms)
      ✓ should include correct claims (6608 ms)
      ✓ should accept custom expiration (6791 ms)
    Cookie functions
      ✓ should set token cookie with correct options (6826 ms)
      ✓ should clear token cookie (6724 ms)
  Error Handler Middleware
    ✓ should handle known errors with status code (6 ms)
    ✓ should handle validation errors with details (4 ms)
    ✓ should handle unknown errors as 500 (4 ms)
    ✓ should handle Sequelize validation errors
    ✓ should handle Sequelize unique constraint errors
    ✓ should log errors in development (1 ms)
  Not Found Middleware
    ✓ should return 404 for non-existent routes (4 ms)
    ✓ should include request information in error (4 ms)
    ✓ should not interfere with existing routes (1 ms)

 PASS  src/__tests__/media.test.js (339.343 s)
  Media Routes
    POST /api/media/upload
      ✓ should upload image file to post (6991 ms)
      ✓ should upload multiple files (7090 ms)
      ✓ should reject upload without authentication (6496 ms)
      ✓ should validate file type restrictions (6990 ms)
      ✓ should validate file size limits (6845 ms)
      ✓ should require either post_id or comment_id (6779 ms)
      ✓ should reject both post_id and comment_id (6848 ms)
      ✓ should validate post exists before upload (6873 ms)
      ✓ should validate comment exists before upload (6987 ms)
      ✓ should validate alt_text length (6811 ms)
      ✓ should handle image processing for thumbnails (6775 ms)
      ✓ should determine media type from MIME type (6996 ms)
      ✓ should generate unique filenames (6868 ms)
      ✓ should create directory structure (6740 ms)
      ✓ should handle upload errors gracefully (7396 ms)
    GET /api/media/:id
      ✓ should return media details (7405 ms)
      ✓ should return 404 for non-existent media (7173 ms)
      ✓ should validate media ID parameter (10024 ms)
    DELETE /api/media/:id
      ✓ should delete media file by owner (7425 ms)
      ✓ should reject deletion by non-owner (7438 ms)
      ✓ should clean up files from filesystem (7601 ms)
      ✓ should clean up thumbnail files (6711 ms)
    Media processing
      ✓ should extract metadata from images (6833 ms)
      ✓ should generate thumbnails for images (6676 ms)
      ✓ should handle different image formats (6873 ms)
      ✓ should validate image dimensions (6867 ms)
    File validation
      ✓ should validate MIME types correctly (6653 ms)
      ✓ should validate file extensions (6698 ms)
      ✓ should sanitize filenames (7323 ms)
    Storage management
      ✓ should organize files by type (7561 ms)
      ✓ should handle storage limits (7537 ms)
      ✓ should generate proper file URLs (7548 ms)

 PASS  src/__tests__/follows.test.js (339.384 s)
  Follows Routes
    POST /api/follows/:userId - Follow user
      ✓ should allow authenticated user to follow another user (7387 ms)
      ✓ should not allow user to follow themselves (7300 ms)
      ✓ should not allow following the same user twice (6941 ms)
      ✓ should require authentication (7322 ms)
      ✓ should update follower/following counts (7258 ms)
    DELETE /api/follows/:userId - Unfollow user
      ✓ should allow unfollowing a user (7149 ms)
      ✓ should update follower/following counts after unfollow (7187 ms)
      ✓ should not allow unfollowing a user not being followed (7587 ms)
      ✓ should require authentication (7192 ms)
    GET /api/follows/followers/:userId - Get followers
      ✓ should return list of followers (7150 ms)
      ✓ should support pagination (7361 ms)
      ✓ should work without authentication for public profiles (7299 ms)
    GET /api/follows/following/:userId - Get following
      ✓ should return list of users being followed (7145 ms)
      ✓ should support pagination (7486 ms)
    GET /api/follows/mutual - Get mutual follows
      ✓ should return only mutual follows (7868 ms)
      ✓ should require authentication (7851 ms)
    GET /api/follows/check/:userId - Check if following
      ✓ should return true if following (9930 ms)
      ✓ should return false if not following (7845 ms)
      ✓ should require authentication (7773 ms)
    GET /api/follows/suggestions - Get follow suggestions
      ✓ should return suggested users to follow (8061 ms)
      ✓ should work without authentication (6996 ms)
    PATCH /api/follows/:userId/mute - Mute user
      ✓ should allow muting a followed user (7115 ms)
      ✓ should not affect follower count when muting (7138 ms)
      ✓ should require authentication (7298 ms)
    PATCH /api/follows/:userId/unmute - Unmute user
      ✓ should allow unmuting a muted user (7243 ms)
      ✓ should require authentication (6992 ms)
    GET /api/follows/stats/:userId - Get follow statistics
      ✓ should return follower and following counts (7197 ms)
      ✓ should include user_stats data (7814 ms)
      ✓ should work without authentication (7859 ms)

 PASS  src/__tests__/users.test.js (339.395 s)
  Users Routes
    GET /api/users
      ✓ should return paginated list of users (7431 ms)
      ✓ should support pagination (11942 ms)
      ✓ should support search functionality (7372 ms)
      ✓ should filter by active status (7197 ms)
      ✓ should include post counts (7031 ms)
      ✓ should validate query parameters (6946 ms)
    GET /api/users/:id
      ✓ should return user profile with posts (6969 ms)
      ✓ should limit posts to 10 recent ones (7403 ms)
      ✓ should return 404 for non-existent user (7008 ms)
      ✓ should validate user ID parameter (7052 ms)
      ✓ should include user statistics (7329 ms)
    POST /api/users
      ✓ should redirect to auth/register (7100 ms)
    PUT /api/users/:id
      ✓ should update user profile by owner (6953 ms)
      ✓ should allow partial updates (7738 ms)
      ✓ should reject update without authentication (7505 ms)
      ✓ should reject update by different user (9648 ms)
      ✓ should allow admin to update any user (8054 ms)
      ✓ should validate update data (7590 ms)
      ✓ should prevent duplicate username/email (7682 ms)
      ✓ should normalize email to lowercase (7530 ms)
      ✓ should return 404 for non-existent user (6873 ms)
      ✓ should update user profile with address fields (8787 ms)
      ✓ should allow partial address field updates (10968 ms)
      ✓ should validate address field lengths (7013 ms)
      ✓ should update avatar_url with relative path (6788 ms)
      ✓ should update avatar_url with full URL (7071 ms)
      ✓ should reject invalid avatar_url format (7561 ms)
      ✓ should geocode address and save GPS coordinates (8283 ms)
      ✓ should geocode city/state without full address (8087 ms)
      ✓ should handle geocoding failure gracefully (7702 ms)
    DELETE /api/users/:id
      ✓ should soft delete user by owner (7614 ms)
      ✓ should reject delete without authentication (7518 ms)
      ✓ should reject delete by different user (7486 ms)
      ✓ should allow admin to delete any user (7658 ms)
      ✓ should return 404 for non-existent user (7520 ms)
    GET /api/users/:id/posts
      ✓ should return user posts with pagination (7612 ms)
      ✓ should return user info with posts (7423 ms)
      ✓ should return 404 for non-existent user (7420 ms)
      ✓ should support pagination parameters (7454 ms)
      ✓ should only show published posts (7387 ms)
      ✓ should include reaction counts in posts (7498 ms)
      ✓ should validate parameters (7460 ms)

 FAIL  src/__tests__/groupComments.test.js (339.427 s)
  Group Comments Routes
    POST /api/groups/:slug/posts/:postId/comments - Create Comment
      ✓ should create a top-level comment (7656 ms)
      ✓ should create a nested reply comment (7509 ms)
      ✓ should require content (7193 ms)
      ✓ should require authentication (7462 ms)
      ✓ should prevent comments on locked posts for non-moderators (7633 ms)
      ✓ should allow moderators to comment on locked posts (7510 ms)
    GET /api/groups/:slug/posts/:postId/comments - List Comments
      ✓ should list all comments for a post (7454 ms)
      ✓ should support best sorting (7851 ms)
      ✓ should support new sorting (7557 ms)
      ✓ should support pagination (7453 ms)
    GET /api/groups/:slug/posts/:postId/comments/nested - Nested Comments
      ✓ should return nested comment structure (7785 ms)
      ✓ should support max_depth parameter (7495 ms)
    GET /api/groups/:slug/comments/:commentId - Get Single Comment
      ✓ should get comment by ID (7460 ms)
      ✓ should return 404 for non-existent comment (8236 ms)
    GET /api/groups/:slug/comments/:commentId/replies - Get Replies
      ✓ should get all direct replies (8054 ms)
    PUT /api/groups/:slug/comments/:commentId - Update Comment
      ✓ should allow author to update their comment (10142 ms)
      ✓ should prevent non-author from updating comment (8167 ms)
      ✓ should require content (7958 ms)
    DELETE /api/groups/:slug/comments/:commentId - Delete Comment
      ✓ should allow author to delete their comment (8250 ms)
      ✓ should allow moderator to delete any comment (7529 ms)
      ✓ should prevent non-author non-moderator from deleting comment (7472 ms)
    POST /api/groups/:slug/comments/:commentId/vote - Vote on Comment
      ✓ should allow upvoting a comment (7274 ms)
      ✓ should allow downvoting a comment (7486 ms)
      ✕ should toggle vote if same vote type (7472 ms)
      ✓ should require authentication (7351 ms)
    DELETE /api/groups/:slug/comments/:commentId/vote - Remove Vote
      ✓ should remove existing vote (7495 ms)
    POST /api/groups/:slug/comments/:commentId/remove - Remove Comment (Moderator)
      ✓ should allow moderator to remove comment with reason (8052 ms)
      ✓ should prevent regular member from removing comment (8082 ms)
      ✓ should require removal_reason (8121 ms)

  ● Group Comments Routes › POST /api/groups/:slug/comments/:commentId/vote - Vote on Comment › should toggle vote if same vote type

    expect(received).toContain(expected) // indexOf

    Expected substring: "removed"
    Received string:    "Vote recorded"

      500 |
      501 |       expectSuccessResponse(response);
    > 502 |       expect(response.body.message).toContain('removed');
          |                                     ^
      503 |     });
      504 |
      505 |     it('should require authentication', async () => {

      at Object.<anonymous> (src/__tests__/groupComments.test.js:502:37)

 PASS  src/__tests__/shares.test.js (339.448 s)
  Shares Routes
    POST /api/shares/:postId - Share post
      ✓ should allow authenticated user to share a post (7338 ms)
      ✓ should allow sharing with a comment (quote) (7364 ms)
      ✓ should not allow sharing own post (6963 ms)
      ✓ should not allow sharing the same post twice (7334 ms)
      ✓ should require authentication (7271 ms)
      ✓ should update share count (7203 ms)
    DELETE /api/shares/:postId - Unshare post
      ✓ should allow unsharing a post (7255 ms)
      ✓ should update share count after unshare (7611 ms)
      ✓ should not allow unsharing a post that was not shared (7200 ms)
      ✓ should require authentication (7230 ms)
    GET /api/shares/user/:userId - Get user shares
      ✓ should return list of shares by a user (7333 ms)
      ✓ should return current user shares when no userId provided (7438 ms)
      ✓ should support pagination (7274 ms)
      ✓ should work without authentication (7489 ms)
    GET /api/shares/post/:postId - Get post shares
      ✓ should return list of shares for a post (7841 ms)
      ✓ should support pagination (7764 ms)
      ✓ should work without authentication (10246 ms)
    GET /api/shares/check/:postId - Check if shared
      ✓ should return true if post is shared (7796 ms)
      ✓ should return false if post is not shared (7786 ms)
      ✓ should require authentication (7914 ms)
    GET /api/shares/popular - Get popular shares
      ✓ should return most shared posts (7168 ms)
      ✓ should support custom timeframe (7219 ms)
      ✓ should work without authentication (7157 ms)
    GET /api/shares/following - Get shares from followed users
      ✓ should return shares from followed users only (7268 ms)
      ✓ should require authentication (7187 ms)
    PATCH /api/shares/:postId/comment - Update share comment
      ✓ should allow updating share comment (7077 ms)
      ✓ should not allow updating another user share (7331 ms)
      ✓ should require authentication (7809 ms)
    GET /api/shares/counts - Get share counts for multiple posts
      ✓ should return share counts for multiple posts (7975 ms)
      ✓ should work without authentication (7966 ms)

 FAIL  src/__tests__/comments.test.js (339.502 s)
  Comments Routes
    GET /api/comments/post/:postId
      ✕ should return hierarchical comments for a post (7118 ms)
      ✓ should support different sorting options (7308 ms)
      ✓ should support limit parameter (7045 ms)
      ✓ should return 404 for non-existent post (7120 ms)
      ✓ should validate query parameters (7074 ms)
      ✓ should only show published comments (6952 ms)
      ✓ should include author information (6976 ms)
      ✓ should include reaction counts (7109 ms)
    GET /api/comments/:id
      ✓ should return single comment with replies (7155 ms)
      ✓ should return 404 for non-existent comment (6955 ms)
      ✓ should validate comment ID parameter (6976 ms)
    POST /api/comments
      ✓ should create a new comment (7229 ms)
      ✓ should create a reply to a comment (7201 ms)
      ✓ should validate required fields (6940 ms)
      ✓ should validate content length (7793 ms)
      ✓ should return 404 for non-existent post (7585 ms)
      ✓ should return 404 for non-existent user (9710 ms)
      ✓ should validate parent comment exists and belongs to same post (7794 ms)
      ✓ should prevent excessive nesting depth (7614 ms)
    PUT /api/comments/:id
      ✓ should update comment content (7735 ms)
      ✓ should return 404 for non-existent comment (7345 ms)
      ✓ should validate content length (7050 ms)
      ✓ should validate comment ID parameter (6831 ms)
    DELETE /api/comments/:id
      ✓ should delete comment and count replies (6943 ms)
      ✓ should delete comment without replies (7050 ms)
      ✓ should return 404 for non-existent comment (6937 ms)
      ✓ should validate comment ID parameter (6854 ms)
    GET /api/comments/:id/replies
      ✓ should return replies for a comment (7283 ms)
      ✓ should support sorting replies (7729 ms)
      ✓ should support limit parameter (8020 ms)
      ✓ should return 404 for non-existent parent comment (7663 ms)
      ✓ should validate parameters (7612 ms)
      ✓ should only show published replies (7575 ms)
      ✓ should return empty array for comment with no replies (7548 ms)
    Comment depth validation
      ✓ should correctly calculate comment depth (7466 ms)
    Comment associations and includes
      ✓ should include media attachments when available (7596 ms)
      ✓ should handle reactions properly in hierarchical structure (7557 ms)

  ● Comments Routes › GET /api/comments/post/:postId › should return hierarchical comments for a post

    expect(received).toBe(expected) // Object.is equality

    Expected: 4
    Received: 1

      82 |       expect(body.data.comments[0].replies).toHaveLength(2);
      83 |       expect(body.data.comments[0].replies[0].replies).toHaveLength(1);
    > 84 |       expect(body.data.total_count).toBe(4);
         |                                     ^
      85 |     });
      86 |
      87 |     it('should support different sorting options', async () => {

      at Object.<anonymous> (src/__tests__/comments.test.js:84:37)

 PASS  src/__tests__/groups.test.js (339.528 s)
  Groups Routes
    POST /api/groups - Create Group
      ✓ should create a new group successfully (7338 ms)
      ✓ should auto-generate slug from name (7434 ms)
      ✓ should require authentication (6966 ms)
      ✓ should require name and display_name (7348 ms)
      ✓ should prevent duplicate group names (7194 ms)
    GET /api/groups - List Groups
      ✓ should list all public groups (7109 ms)
      ✓ should support pagination (7223 ms)
    GET /api/groups/:slug - Get Group Details
      ✓ should get group details by slug (7546 ms)
      ✓ should return 404 for non-existent group (7154 ms)
    PUT /api/groups/:slug - Update Group (Admin Only)
      ✓ should allow admin to update group settings (7123 ms)
      ✓ should prevent non-admin from updating group (7269 ms)
      ✓ should require authentication (7417 ms)
    DELETE /api/groups/:slug - Delete Group (Admin Only)
      ✓ should allow admin to delete group (7233 ms)
      ✓ should prevent non-admin from deleting group (7436 ms)
    POST /api/groups/:slug/join - Join Group
      ✓ should allow user to join public group (7869 ms)
      ✓ should prevent duplicate joins (7807 ms)
      ✓ should require authentication (9909 ms)
    POST /api/groups/:slug/leave - Leave Group
      ✓ should allow member to leave group (7890 ms)
      ✓ should prevent creator from leaving (7836 ms)
      ✓ should prevent non-member from leaving (7987 ms)
    POST /api/groups/:slug/members/:userId/role - Change Member Role (Admin Only)
      ✓ should allow admin to promote member to moderator (7134 ms)
      ✓ should allow admin to promote member to admin (7121 ms)
      ✓ should prevent non-admin from changing roles (6989 ms)
      ✓ should validate role value (7309 ms)
    POST /api/groups/:slug/members/:userId/ban - Ban Member (Moderator/Admin)
      ✓ should allow admin to ban member (7257 ms)
      ✓ should allow moderator to ban member (7018 ms)
      ✓ should prevent regular member from banning (7259 ms)
    POST /api/groups/:slug/members/:userId/unban - Unban Member (Moderator/Admin)
      ✓ should allow admin to unban member (7776 ms)
      ✓ should prevent non-moderator from unbanning (7861 ms)
    GET /api/groups/:slug/members - List Group Members
      ✓ should list all group members (7865 ms)
      ✓ should filter by role (7807 ms)
      ✓ should filter by status (7854 ms)
    GET /api/groups/search - Search Groups
      ✓ should search groups by query (7714 ms)
      ✓ should return empty results for no match (7713 ms)

 PASS  src/__tests__/posts.test.js (339.54 s)
  Posts Routes
    GET /api/posts
      ✓ should return public posts for unauthenticated users (7002 ms)
      ✓ should return appropriate posts for authenticated users (7319 ms)
      ✓ should support pagination (7107 ms)
      ✓ should support filtering by user_id (7156 ms)
      ✓ should support sorting by newest/oldest (7024 ms)
      ✓ should support privacy level filtering (6973 ms)
      ✓ should include author information (6974 ms)
      ✓ should include reaction counts (7193 ms)
      ✓ should validate query parameters (7074 ms)
      ✓ should handle empty results gracefully (6940 ms)
    GET /api/posts/:id
      ✓ should return post details for public post (7039 ms)
      ✓ should return post with comments tree (7160 ms)
      ✓ should include media attachments (7185 ms)
      ✓ should return 404 for non-existent post (7021 ms)
      ✓ should return 403 for private post by other user (7786 ms)
      ✓ should allow owner to view their private post (7562 ms)
      ✓ should validate post ID parameter (9701 ms)
    POST /api/posts
      ✓ should create a new post with valid data (7799 ms)
      ✓ should create post with default privacy level (7532 ms)
      ✓ should reject post creation without authentication (7733 ms)
      ✓ should validate content length (7415 ms)
      ✓ should validate privacy level (7033 ms)
      ✓ should trim whitespace from content (6828 ms)
    PUT /api/posts/:id
      ✓ should update post by owner (6949 ms)
      ✓ should allow partial updates (7009 ms)
      ✓ should reject update without authentication (6999 ms)
      ✓ should reject update by non-owner (6880 ms)
      ✓ should allow admin to update any post (7411 ms)
      ✓ should return 404 for non-existent post (7647 ms)
      ✓ should validate update data (7727 ms)
    DELETE /api/posts/:id
      ✓ should delete post by owner (7744 ms)
      ✓ should reject delete without authentication (7606 ms)
      ✓ should reject delete by non-owner (7531 ms)
      ✓ should allow admin to delete any post (7733 ms)
      ✓ should return 404 for non-existent post (7426 ms)
      ✓ should cascade delete comments and reactions (7622 ms)
      ✓ should validate post ID parameter (7518 ms)
    Post visibility and privacy
      ✓ should respect privacy levels for unauthenticated users (7462 ms)
      ✓ should handle unpublished posts correctly (7427 ms)

 FAIL  src/__tests__/groupPosts.test.js (339.606 s)
  Group Posts Routes
    POST /api/groups/:slug/posts - Create Post
      ✓ should create a text post successfully (7525 ms)
      ✓ should create a link post successfully (7568 ms)
      ✓ should require title (7159 ms)
      ✓ should require authentication (7461 ms)
      ✓ should create pending post if approval required (7479 ms)
      ✓ should allow moderator to bypass approval (7435 ms)
    GET /api/groups/:slug/posts - List Posts
      ✓ should list all published posts (7432 ms)
      ✓ should support hot sorting (7788 ms)
      ✓ should support new sorting (7536 ms)
      ✓ should support pagination (7440 ms)
    GET /api/groups/:slug/posts/:postId - Get Single Post
      ✓ should get post by ID (7712 ms)
      ✓ should return 404 for non-existent post (7511 ms)
    PUT /api/groups/:slug/posts/:postId - Update Post
      ✓ should allow author to update their post (7398 ms)
      ✓ should allow moderator to update any post (8105 ms)
      ✓ should prevent non-author non-moderator from updating post (7997 ms)
    DELETE /api/groups/:slug/posts/:postId - Delete Post
      ✓ should allow author to delete their post (10164 ms)
      ✓ should allow moderator to delete any post (8287 ms)
      ✓ should prevent non-author non-moderator from deleting post (7999 ms)
    POST /api/groups/:slug/posts/:postId/vote - Vote on Post
      ✓ should allow upvoting a post (8168 ms)
      ✓ should allow downvoting a post (7494 ms)
      ✕ should toggle vote if same vote type (7515 ms)
      ✓ should change vote if different vote type (7276 ms)
      ✓ should require authentication (7449 ms)
      ✓ should validate vote_type (7458 ms)
    DELETE /api/groups/:slug/posts/:postId/vote - Remove Vote
      ✓ should remove existing vote (7336 ms)
    POST /api/groups/:slug/posts/:postId/pin - Pin Post (Moderator)
      ✓ should allow moderator to pin post (7393 ms)
      ✓ should allow moderator to unpin post (8035 ms)
      ✓ should prevent regular member from pinning (8172 ms)
    POST /api/groups/:slug/posts/:postId/lock - Lock Post (Moderator)
      ✓ should allow moderator to lock post (8161 ms)
      ✓ should prevent non-moderator from locking (8064 ms)
    POST /api/groups/:slug/posts/:postId/remove - Remove Post (Moderator)
      ✓ should allow moderator to remove post with reason (8052 ms)
      ✓ should prevent regular member from removing post (7951 ms)
      ✓ should require removal_reason (7839 ms)
    POST /api/groups/:slug/posts/:postId/approve - Approve Post (Moderator)
      ✓ should allow moderator to approve pending post (8027 ms)
      ✓ should prevent regular member from approving (7940 ms)
    GET /api/groups/:slug/posts/pending - List Pending Posts (Moderator)
      ✕ should allow moderator to view pending posts (7921 ms)
      ✓ should prevent regular member from viewing pending posts (7907 ms)
    GET /api/groups/:slug/posts/top - Top Posts by Period
      ✕ should get top posts for day (7891 ms)
      ✕ should get top posts for week (7880 ms)
      ✓ should default to all time if no period (7897 ms)

  ● Group Posts Routes › POST /api/groups/:slug/posts/:postId/vote - Vote on Post › should toggle vote if same vote type

    expect(received).toContain(expected) // indexOf

    Expected substring: "removed"
    Received string:    "Vote recorded"

      424 |
      425 |       expectSuccessResponse(response);
    > 426 |       expect(response.body.message).toContain('removed');
          |                                     ^
      427 |       expect(response.body.data.counts.score).toBe('0');
      428 |     });
      429 |

      at Object.<anonymous> (src/__tests__/groupPosts.test.js:426:37)

  ● Group Posts Routes › GET /api/groups/:slug/posts/pending - List Pending Posts (Moderator) › should allow moderator to view pending posts

    TypeError: Cannot read properties of undefined (reading 'length')

      688 |
      689 |       expectSuccessResponse(response);
    > 690 |       expect(response.body.data.posts.length).toBe(2);
          |                                       ^
      691 |       response.body.data.posts.forEach(post => {
      692 |         expect(post.status).toBe('pending');
      693 |       });

      at Object.<anonymous> (src/__tests__/groupPosts.test.js:690:39)

  ● Group Posts Routes › GET /api/groups/:slug/posts/top - Top Posts by Period › should get top posts for day

    TypeError: Cannot read properties of undefined (reading 'length')

      732 |
      733 |       expectSuccessResponse(response);
    > 734 |       expect(response.body.data.posts.length).toBeGreaterThan(0);
          |                                       ^
      735 |     });
      736 |
      737 |     it('should get top posts for week', async () => {

      at Object.<anonymous> (src/__tests__/groupPosts.test.js:734:39)

  ● Group Posts Routes › GET /api/groups/:slug/posts/top - Top Posts by Period › should get top posts for week

    TypeError: Cannot read properties of undefined (reading 'length')

      740 |
      741 |       expectSuccessResponse(response);
    > 742 |       expect(response.body.data.posts.length).toBeGreaterThan(0);
          |                                       ^
      743 |     });
      744 |
      745 |     it('should default to all time if no period', async () => {

      at Object.<anonymous> (src/__tests__/groupPosts.test.js:742:39)

 PASS  src/__tests__/auth.test.js (339.636 s)
  Authentication Routes
    POST /api/auth/register
      ✓ should register a new user with valid data (7013 ms)
      ✓ should reject registration with invalid email (6745 ms)
      ✓ should reject registration with weak password (6410 ms)
      ✓ should reject registration with short username (6846 ms)
      ✓ should reject registration with non-alphanumeric username (6633 ms)
      ✓ should reject registration with duplicate username (6738 ms)
      ✓ should reject registration with duplicate email (6821 ms)
      ✓ should normalize email to lowercase (6730 ms)
      ✓ should trim whitespace from string fields (7037 ms)
      ✓ should validate bio length if provided (6627 ms)
      ✓ should accept valid avatar URL (6712 ms)
      ✓ should reject invalid avatar URL (6913 ms)
    POST /api/auth/login
      ✓ should login with valid username and password (7154 ms)
      ✓ should login with valid email and password (6952 ms)
      ✓ should reject login with invalid username (7270 ms)
      ✓ should reject login with invalid password (7630 ms)
      ✓ should reject login for inactive account (7392 ms)
      ✓ should handle remember_me option (9671 ms)
      ✓ should validate required fields (7449 ms)
      ✓ should normalize email case in identifier (7691 ms)
    POST /api/auth/logout
      ✓ should logout authenticated user (7575 ms)
      ✓ should reject logout without authentication (6638 ms)
      ✓ should reject logout with invalid token (6825 ms)
    GET /api/auth/me
      ✓ should return user profile when authenticated (6569 ms)
      ✓ should reject request when not authenticated (6857 ms)
      ✓ should reject request with invalid token (6641 ms)
      ✓ should reject request with expired token (6769 ms)
    POST /api/auth/refresh
      ✓ should refresh token for authenticated user (6697 ms)
      ✓ should reject refresh without authentication (7155 ms)
    POST /api/auth/forgot-password
      ✓ should handle forgot password request for existing user (7480 ms)
      ✓ should handle forgot password request for non-existing user (7654 ms)
      ✓ should validate email format (7485 ms)
      ✓ should require email field (7395 ms)
    POST /api/auth/reset-password
      ✓ should reset password with valid token (7948 ms)
      ✓ should reject invalid reset token (7308 ms)
      ✓ should reject expired reset token (7288 ms)
      ✓ should validate new password strength (7337 ms)
      ✓ should require both token and password (7331 ms)
    POST /api/auth/change-password
      ✓ should change password for authenticated user (7840 ms)
      ✓ should reject change with wrong current password (7407 ms)
      ✓ should reject change without authentication (7259 ms)
      ✓ should validate new password strength (7177 ms)
      ✓ should require both passwords (7160 ms)
    POST /api/auth/verify-email
      ✓ should verify email with valid token (7316 ms)
      ✓ should reject invalid verification token (7297 ms)
      ✓ should require verification token (6722 ms)

 PASS  src/__tests__/reactions.test.js (339.773 s)
  Reactions Routes
    POST /api/reactions/post/:postId
      ✓ should add reaction to post with emoji name only (7272 ms)
      ✓ should add reaction with both name and unicode (7176 ms)
      ✓ should toggle reaction (remove if exists) (6823 ms)
      ✓ should validate required fields (7180 ms)
      ✓ should validate emoji name length (7137 ms)
      ✓ should return 404 for non-existent post (6922 ms)
      ✓ should ignore user_id in request body and use authenticated user (6963 ms)
      ✓ should normalize emoji names (7250 ms)
      ✓ should use common emoji mappings (7119 ms)
    POST /api/reactions/comment/:commentId
      ✓ should add reaction to comment (6938 ms)
      ✓ should toggle comment reaction (7127 ms)
      ✓ should return 404 for non-existent comment (7179 ms)
      ✓ should validate comment ID parameter (7168 ms)
    GET /api/reactions/post/:postId
      ✓ should return reaction counts for post (7184 ms)
      ✓ should include detailed reactions when requested (7810 ms)
      ✓ should return 404 for non-existent post (7635 ms)
      ✓ should validate query parameters (9759 ms)
      ✓ should return empty counts for post with no reactions (7766 ms)
    GET /api/reactions/comment/:commentId
      ✓ should return reaction counts for comment (7554 ms)
      ✓ should include user details when requested (7732 ms)
      ✓ should return 404 for non-existent comment (7199 ms)
    GET /api/reactions/user/:userId
      ✓ should return paginated user reactions (7169 ms)
      ✓ should support filtering by reaction type (6898 ms)
      ✓ should support pagination (7151 ms)
      ✓ should return 404 for non-existent user (7009 ms)
      ✓ should validate query parameters (7018 ms)
      ✓ should include associated post/comment author information (6947 ms)
    DELETE /api/reactions/:id
      ✓ should delete a reaction (7397 ms)
      ✓ should return updated reaction counts after deletion (7747 ms)
      ✓ should return 404 for non-existent reaction (7796 ms)
      ✓ should validate reaction ID parameter (7762 ms)
    GET /api/reactions/emoji-list
      ✓ should return available emoji list (7657 ms)
      ✓ should include common emojis (7597 ms)
      ✓ should format display names properly (7525 ms)
    GET /api/reactions/stats/popular
      ✓ should return popular emoji statistics (7474 ms)
      ✓ should support custom time period (7550 ms)
      ✓ should support custom limit (7596 ms)
      ✓ should validate query parameters (7477 ms)
      ✓ should order by usage count descending (7471 ms)
    Reaction normalization and validation
      ✓ should handle emoji unicode properly (7401 ms)
      ✓ should sanitize emoji names (7466 ms)
      ✓ should convert emoji names to lowercase (7464 ms)
      ✓ should map alternative emoji names to standard unicode (7466 ms)
    Reaction aggregation and counting
      ✓ should properly aggregate multiple reactions of same type (7188 ms)
      ✓ should handle mixed reaction types (6521 ms)

Test Suites: 4 failed, 11 passed, 15 total
Tests:       6 failed, 495 passed, 501 total
Snapshots:   0 total
Time:        339.926 s
Ran all test suites.
Force exiting Jest: Have you considered using `--detectOpenHandles` to detect async operations that kept running after all tests finished?
 jason  ~/Development/claude/posting-system-refactor/backend  1  

